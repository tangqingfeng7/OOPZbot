<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oopz Music Player</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#1a1a2e;
  --bg-card:#16213e;
  --bg-card2:#0f3460;
  --accent:#e94560;
  --accent-glow:rgba(233,69,96,.35);
  --text:#eee;
  --text-dim:#8892a4;
  --text-muted:#556;
  --radius:12px;
}
html,body{height:100%;font-family:'Segoe UI','PingFang SC','Microsoft YaHei',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}

.container{
  display:grid;
  grid-template-columns:320px 1fr 340px;
  height:100vh;
  gap:0;
}

/* ===== Left: Song Info ===== */
.panel-left{
  background:var(--bg-card);
  display:flex;flex-direction:column;align-items:center;
  padding:40px 28px 28px;
  border-right:1px solid rgba(255,255,255,.06);
  overflow-y:auto;
}
.cover-wrap{
  position:relative;width:240px;height:240px;margin-bottom:24px;flex-shrink:0;
}
.cover-wrap img{
  width:100%;height:100%;object-fit:cover;border-radius:var(--radius);
  box-shadow:0 8px 32px rgba(0,0,0,.45);
  transition:opacity .4s;
}
.cover-wrap .badge{
  position:absolute;top:12px;left:12px;
  background:var(--accent);color:#fff;font-size:11px;font-weight:700;
  padding:3px 10px;border-radius:20px;letter-spacing:.5px;
  box-shadow:0 2px 8px var(--accent-glow);
}
.song-name{
  font-size:20px;font-weight:700;text-align:center;
  margin-bottom:6px;line-height:1.3;
  max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.song-artist{
  font-size:14px;color:var(--text-dim);text-align:center;margin-bottom:14px;
  max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.platform-tag{
  display:inline-block;
  font-size:11px;font-weight:600;color:#fff;
  background:linear-gradient(135deg,#e94560,#c62a4f);
  padding:2px 12px;border-radius:20px;margin-bottom:24px;letter-spacing:1px;
}

.progress-section{width:100%;margin-top:auto;flex-shrink:0}
.progress-bar{
  width:100%;height:4px;background:rgba(255,255,255,.1);border-radius:2px;
  overflow:hidden;cursor:pointer;margin-bottom:8px;
}
.progress-bar .fill{
  height:100%;background:var(--accent);border-radius:2px;
  transition:width .3s linear;width:0;
}
.progress-time{display:flex;justify-content:space-between;font-size:12px;color:var(--text-dim)}

.idle-hint{color:var(--text-muted);font-size:15px;margin-top:40px}

/* ===== Center: Lyrics ===== */
.panel-center{
  display:flex;flex-direction:column;align-items:center;
  padding:0;overflow:hidden;position:relative;
}
.lyrics-header{
  width:100%;text-align:center;padding:18px 0 10px;
  font-size:13px;color:var(--text-dim);letter-spacing:1px;font-weight:600;
  border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;
}
.lyrics-scroll{
  flex:1;width:100%;overflow-y:auto;
  padding:40px 48px;
  mask-image:linear-gradient(to bottom,transparent 0%,#000 12%,#000 88%,transparent 100%);
  -webkit-mask-image:linear-gradient(to bottom,transparent 0%,#000 12%,#000 88%,transparent 100%);
  scroll-behavior:smooth;
}
.lyrics-scroll::-webkit-scrollbar{width:4px}
.lyrics-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}
.lyric-line{
  text-align:center;padding:10px 0;font-size:16px;color:var(--text-muted);
  transition:color .3s,font-size .3s,transform .3s;line-height:1.6;
}
.lyric-line.active{
  color:#fff;font-size:22px;font-weight:700;
  text-shadow:0 0 20px var(--accent-glow);
  transform:scale(1.02);
}
.lyric-line.near{color:var(--text-dim)}
.no-lyric{
  text-align:center;color:var(--text-muted);font-size:16px;
  padding-top:40vh;
}

/* ===== Right: Queue ===== */
.panel-right{
  background:var(--bg-card);
  display:flex;flex-direction:column;
  border-left:1px solid rgba(255,255,255,.06);
}
.queue-header{
  padding:18px 20px 12px;font-size:13px;color:var(--text-dim);
  letter-spacing:1px;font-weight:600;
  border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;
}
.queue-list{
  flex:1;overflow-y:auto;padding:8px 0;
}
.queue-list::-webkit-scrollbar{width:4px}
.queue-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}
.queue-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 20px;cursor:default;
  transition:background .2s;
}
.queue-item:hover{background:rgba(255,255,255,.04)}
.queue-item.now-playing{background:rgba(233,69,96,.12)}
.queue-idx{width:22px;text-align:center;font-size:13px;color:var(--text-muted);flex-shrink:0}
.queue-item.now-playing .queue-idx{color:var(--accent);font-weight:700}
.queue-thumb{
  width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0;
  background:var(--bg);
}
.queue-info{flex:1;min-width:0}
.queue-info .q-name{
  font-size:14px;font-weight:500;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.queue-item.now-playing .q-name{color:var(--accent)}
.queue-info .q-artist{font-size:12px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.queue-dur{font-size:12px;color:var(--text-muted);flex-shrink:0}
.queue-empty{text-align:center;color:var(--text-muted);font-size:14px;padding:40px 20px}

/* Responsive */
@media(max-width:1100px){
  .container{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;height:auto;min-height:100vh}
  .panel-left{flex-direction:row;padding:20px;gap:20px;border-right:none;border-bottom:1px solid rgba(255,255,255,.06)}
  .cover-wrap{width:100px;height:100px;margin-bottom:0}
  .panel-left .info-text{text-align:left}
  .progress-section{margin-top:12px}
  .lyrics-scroll{padding:20px}
  .panel-right{max-height:35vh;border-left:none;border-top:1px solid rgba(255,255,255,.06)}
}
</style>
</head>
<body>
<div class="container">
  <!-- Left Panel -->
  <div class="panel-left" id="panelLeft">
    <div class="cover-wrap">
      <img id="cover" src="" alt="cover">
      <span class="badge" id="badge" style="display:none">PLAYING</span>
    </div>
    <div class="song-name" id="songName">等待播放...</div>
    <div class="song-artist" id="songArtist">&nbsp;</div>
    <div class="platform-tag" id="platformTag" style="display:none">NETEASE</div>
    <div class="progress-section" id="progressSection" style="visibility:hidden">
      <div class="progress-bar" id="progressBar"><div class="fill" id="progressFill"></div></div>
      <div class="progress-time">
        <span id="timeCur">0:00</span>
        <span id="timeTotal">0:00</span>
      </div>
    </div>
  </div>

  <!-- Center Panel -->
  <div class="panel-center">
    <div class="lyrics-header">LYRICS</div>
    <div class="lyrics-scroll" id="lyricsScroll">
      <div class="no-lyric" id="noLyric">暂无歌词</div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="panel-right">
    <div class="queue-header">PLAY QUEUE</div>
    <div class="queue-list" id="queueList">
      <div class="queue-empty">队列为空</div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);

  let currentId = null;
  let lyrics = [];          // [{time:秒, text:'歌词'}]
  let activeLine = -1;
  let polling = null;

  function fmtTime(sec){
    if(!sec||sec<0) sec=0;
    const m=Math.floor(sec/60), s=Math.floor(sec%60);
    return m+':'+(s<10?'0':'')+s;
  }

  function parseLRC(lrc){
    if(!lrc) return [];
    const lines=[], re=/\[(\d{1,3}):(\d{2})(?:\.(\d{1,3}))?\]/g;
    for(const raw of lrc.split('\n')){
      let match; const times=[];
      while((match=re.exec(raw))!==null){
        const min=parseInt(match[1]), sec=parseInt(match[2]);
        const ms=match[3]?parseInt(match[3].padEnd(3,'0')):0;
        times.push(min*60+sec+ms/1000);
      }
      const text=raw.replace(/\[.*?\]/g,'').trim();
      if(text) for(const t of times) lines.push({time:t,text});
    }
    lines.sort((a,b)=>a.time-b.time);
    return lines;
  }

  function renderLyrics(){
    const el=$('lyricsScroll');
    if(!lyrics.length){
      el.innerHTML='<div class="no-lyric">暂无歌词</div>';
      return;
    }
    el.innerHTML=lyrics.map((l,i)=>`<div class="lyric-line" data-idx="${i}">${l.text}</div>`).join('');
  }

  function highlightLyric(progress){
    if(!lyrics.length) return;
    let idx=-1;
    for(let i=lyrics.length-1;i>=0;i--){
      if(progress>=lyrics[i].time){idx=i;break;}
    }
    if(idx===activeLine) return;
    activeLine=idx;
    const el=$('lyricsScroll');
    const lines=el.querySelectorAll('.lyric-line');
    lines.forEach((ln,i)=>{
      ln.classList.remove('active','near');
      if(i===idx) ln.classList.add('active');
      else if(Math.abs(i-idx)<=2) ln.classList.add('near');
    });
    if(idx>=0&&lines[idx]){
      const container=el;
      const lineEl=lines[idx];
      const top=lineEl.offsetTop-container.clientHeight/2+lineEl.clientHeight/2;
      container.scrollTo({top:Math.max(0,top),behavior:'smooth'});
    }
  }

  async function fetchStatus(){
    try{
      const r=await fetch('/api/status');
      const d=await r.json();
      if(!d.playing){
        if(currentId!==null){
          currentId=null;lyrics=[];activeLine=-1;
          $('songName').textContent='等待播放...';
          $('songArtist').innerHTML='&nbsp;';
          $('cover').src='';
          $('badge').style.display='none';
          $('platformTag').style.display='none';
          $('progressSection').style.visibility='hidden';
          $('progressFill').style.width='0';
          renderLyrics();
        }
        return;
      }

      if(d.id!==currentId){
        currentId=d.id;
        $('songName').textContent=d.name||'';
        $('songArtist').textContent=d.artists||'';
        $('cover').src=d.cover||'';
        $('badge').style.display='inline-block';
        $('platformTag').style.display='inline-block';
        $('progressSection').style.visibility='visible';
        $('timeTotal').textContent=d.durationText||fmtTime(d.duration);
        activeLine=-1;
        fetchLyric(d.id);
      }

      const pct=d.duration>0?Math.min(d.progress/d.duration*100,100):0;
      $('progressFill').style.width=pct+'%';
      $('timeCur').textContent=fmtTime(d.progress);
      highlightLyric(d.progress);
    }catch(e){console.error('fetchStatus error:',e);}
  }

  async function fetchLyric(id){
    try{
      const r=await fetch('/api/lyric?id='+id);
      const d=await r.json();
      lyrics=parseLRC(d.lyric);
      renderLyrics();
    }catch(e){console.error('fetchLyric error:',e);lyrics=[];renderLyrics();}
  }

  async function fetchQueue(){
    try{
      const r=await fetch('/api/queue');
      const d=await r.json();
      const el=$('queueList');
      if(!d.queue||!d.queue.length){
        el.innerHTML='<div class="queue-empty">队列为空</div>';
        return;
      }
      el.innerHTML=d.queue.map((s,i)=>`
        <div class="queue-item">
          <span class="queue-idx">${i+1}</span>
          <img class="queue-thumb" src="${s.cover||''}" alt="" loading="lazy" onerror="this.style.visibility='hidden'">
          <div class="queue-info">
            <div class="q-name">${s.name||''}</div>
            <div class="q-artist">${s.artists||''}</div>
          </div>
          <span class="queue-dur">${s.durationText||''}</span>
        </div>
      `).join('');
    }catch(e){}
  }

  function startPolling(){
    fetchStatus();
    fetchQueue();
    setInterval(fetchStatus,1000);
    setInterval(fetchQueue,5000);
  }

  startPolling();
})();
</script>
</body>
</html>
